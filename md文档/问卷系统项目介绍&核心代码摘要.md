# 问卷系统项目介绍

## 1. 项目概述

本项目是一个功能完善的在线问卷调查系统，支持问卷的创建、发布、填写、数据收集和统计分析等功能。系统采用前后端分离架构，提供了友好的用户界面和丰富的问卷题型，满足各类用户的问卷调查需求。

### 1.1 项目特点

- **功能丰富**：支持多种题型，包括单选、多选、填空、图片选择等
- **灵活配置**：支持问卷逻辑跳转、条件显示、必填设置等
- **数据分析**：提供多维度的数据统计和可视化图表
- **用户友好**：简洁直观的操作界面，支持模板复用
- **安全可靠**：完善的权限控制和数据保护机制

## 2. 技术架构

### 2.1 整体架构

项目采用前后端分离的架构设计，后端提供 RESTful API 接口，前端通过 HTTP 请求与后端交互。

![架构图](架构图示意)

### 2.2 技术栈

#### 后端技术栈

- **核心框架**：Spring Boot
- **ORM 框架**：MyBatis-Plus
- **数据库**：MySQL
- **缓存**：EhCache
- **安全认证**：JWT (JSON Web Token)
- **API 文档**：Swagger
- **工具库**：Hutool、Lombok

#### 前端技术栈

- **核心框架**：Vue.js
- **UI 组件库**：Element UI
- **状态管理**：Vuex
- **路由管理**：Vue Router
- **HTTP 客户端**：Axios
- **图表库**：ECharts
- **表单生成器**：自定义表单组件

#### 部署环境

- **应用服务器**：内嵌 Tomcat
- **Web 服务器**：Nginx
- **容器化**：Docker

## 3. 数据库设计

### 3.1 主要数据表

- **fm_user_form**：用户表单主表，存储表单基本信息
- **fm_user_form_item**：表单项表，存储表单中的题目信息
- **fm_user_form_data**：表单数据表，存储用户填写的表单数据
- **fm_user_form_theme**：表单主题表，存储表单的样式和主题设置
- **fm_user_form_logic**：表单逻辑表，存储表单的逻辑跳转规则
- **fm_user_form_setting**：表单设置表，存储表单的各种配置项
- **fm_form_template**：表单模板表，存储系统预设和用户自定义的模板
- **fm_user**：用户表，存储用户账号信息

### 3.2 数据库关系图

主要表之间的关系如下：

- 一个用户可以创建多个表单（一对多）
- 一个表单包含多个表单项（一对多）
- 一个表单可以收集多条数据（一对多）
- 一个表单关联一个主题设置（一对一）
- 一个表单关联一个逻辑设置（一对一）

## 4. 用户角色

系统主要包含以下用户角色：

### 4.1 管理员

- 系统管理权限
- 用户管理权限
- 模板管理权限
- 所有表单的查看和管理权限

### 4.2 普通用户

- 创建和管理自己的表单
- 查看自己表单的数据和统计结果
- 使用系统提供的模板

### 4.3 匿名用户

- 通过链接填写问卷
- 无需登录即可提交数据

## 5. 功能模块

### 5.1 用户认证模块

- 用户注册
- 用户登录
- 密码找回
- 权限控制

### 5.2 表单设计模块

- 创建新表单
- 编辑表单内容
- 设置表单样式
- 配置表单逻辑
- 表单预览

### 5.3 表单管理模块

- 表单列表查看
- 表单状态管理（草稿、发布、停止）
- 表单分享和发布
- 表单复制和删除

### 5.4 问卷填写模块

- 问卷展示和填写
- 表单验证
- 提交结果展示
- 移动端适配

### 5.5 数据收集模块

- 数据列表查看
- 数据筛选和搜索
- 数据导出（Excel、CSV）
- 数据删除和管理

### 5.6 统计分析模块

- 回收概况统计
- 题目数据分析
- 图表可视化展示
- 交叉分析

### 5.7 模板管理模块

- 系统模板管理
- 用户模板创建和使用
- 模板分类和搜索

## 6. 核心功能点

### 6.1 丰富的题型支持

- 单选题
- 多选题
- 填空题
- 下拉选择题
- 图片选择题
- 评分题
- 日期选择题
- 地址选择题
- 文件上传题

### 6.2 表单逻辑设置

- 条件显示/隐藏
- 逻辑跳转
- 选项关联

### 6.3 表单设置功能

- 填写权限控制
- 填写次数限制
- 定时开放/关闭
- 提交后行为设置
- 数据校验规则

### 6.4 数据分析功能

- 基础统计信息
- 选项分布分析
- 多维度图表展示
- 地域分布分析
- 设备来源分析

### 6.5 分享与协作

- 链接分享
- 二维码分享
- 社交媒体分享

## 7. 系统流程

### 7.1 表单创建流程

1. 用户登录系统
2. 选择创建新表单或使用模板
3. 设计表单内容和样式
4. 配置表单逻辑和设置
5. 预览和保存表单
6. 发布表单

### 7.2 问卷填写流程

1. 用户访问问卷链接
2. 查看问卷说明
3. 填写问卷内容
4. 提交问卷
5. 查看提交结果

### 7.3 数据分析流程

1. 表单创建者登录系统
2. 进入表单数据页面
3. 查看数据列表和统计图表
4. 导出或管理数据

## 8. 系统特色与功能实现示例

### 8.1 用户体验优化

#### 8.1.1 响应式设计

- 采用弹性布局和媒体查询技术，适配不同屏幕尺寸
- 针对移动端优化交互方式，提升触控体验
- 自适应表单元素，确保在各种设备上的可用性

#### 8.1.2 操作界面优化

- 简洁直观的操作界面，减少学习成本
- 引导式操作流程，降低使用门槛
- 快捷键支持，提高操作效率

#### 8.1.3 实时预览与编辑

- 表单设计实时预览功能，所见即所得
- 拖拽式表单设计，支持组件快速排序
- 表单项属性实时编辑，即时反馈

### 8.2 高级功能实现

#### 8.2.1 问卷模板市场

- 系统预设多种行业模板，满足不同场景需求
- 用户可将自己的表单保存为模板并分享
- 模板分类管理和搜索功能

#### 8.2.2 数据实时统计

- 实时更新的数据统计面板
- 多维度数据分析，包括时间、地域、设备等
- 自定义统计周期和筛选条件

#### 8.2.3 表单逻辑实现

```javascript
// 表单逻辑条件判断示例
export function evalExpression(context, expression) {
  let exArray = expression.split(/and|or/);
  // 获取是& 还是|
  let and = expression.indexOf("and") > -1;
  let flag = false;
  for (let i = 0; i < exArray.length; i++) {
    let itemExpArr = exArray[i].split(" ");
    // 截取字段名
    let varName = itemExpArr[0];
    // 条件 等于 不等于
    let sp = itemExpArr[1];
    // 值
    let value = itemExpArr[2];
    // 比较是否成立
    let fieldValue = _.get(context, varName);
    flag = expressionOperator[sp](fieldValue, value);
    // & 一个不成立直接调出循环 返回失败
    if (and && !flag) {
      break;
      // | 一个成立直接调出循环 返回成功
    } else if (!and && flag) {
      break;
    }
  }
  return flag;
}
```

#### 8.2.4 自定义表单样式

- 丰富的主题设置选项，包括颜色、字体、背景等
- 自定义 CSS 样式支持，满足个性化需求
- 表单元素样式预设，快速应用统一风格

### 8.3 安全性实现

#### 8.3.1 数据加密存储

- 敏感数据加密存储，保护用户隐私
- 传输过程采用 HTTPS 协议，确保数据传输安全
- 密码采用不可逆加密算法存储

```java
/**
 * 密码加密工具类
 */
public class PasswordUtils {

    /**
     * 密码加密
     */
    public static String encode(String password) {
        return BCrypt.hashpw(password, BCrypt.gensalt());
    }

    /**
     * 密码校验
     */
    public static boolean checkPassword(UserEntity userEntity, String password) {
        return BCrypt.checkpw(password, userEntity.getPassword());
    }
}
```

#### 8.3.2 访问权限控制

- 基于 JWT 的用户认证机制
- 细粒度的权限控制，区分管理员和普通用户
- 表单级别的权限设置，控制查看和编辑权限

```java
/**
 * 表单权限工具类
 */
@UtilityClass
public class FormAuthUtils {

    /**
     * 是否拥有表单的权限
     */
    public void hasPermission(String formKey) {
        // 是否是超级管理员
        if (SecurityUtils.isAdmin(SecurityUtils.getUserId())) {
            return;
        }
        UserFormService userFormService = SpringContextUtils.getBean(UserFormService.class);
        UserFormEntity userFormEntity = userFormService.getByKey(formKey);
        if(ObjectUtil.isNull(userFormEntity)){
            return;
        }
        // 是否是所有者
        if (!userFormEntity.getUserId().equals(SecurityUtils.getUserId())) {
            throw new BaseException("无表单权限");
        }
    }
}
```

#### 8.3.3 防重复提交机制

- 表单提交 Token 验证，防止重复提交
- IP 限制和时间间隔控制，防止恶意提交
- 客户端状态记录，避免用户误操作重复提交

#### 8.3.4 数据备份与恢复

- 定时数据库备份机制，确保数据安全
- 多级备份策略，包括全量备份和增量备份
- 数据恢复工具，支持指定时间点恢复

## 9. 技术实现细节

### 9.1 后端实现

#### 9.1.1 核心模块实现

1. **表单核心模块**

   - 采用实体类与数据表映射，使用 MyBatis-Plus 简化数据库操作
   - 表单实体设计包含基础信息、状态、类型等属性
   - 表单项实体设计支持多种题型，包含排序、必填、校验等属性

2. **数据处理模块**

   - 使用 JSON 格式存储表单数据，支持复杂结构
   - 实现数据导入导出功能，支持 Excel 格式
   - 提供数据筛选和查询接口，支持复杂条件查询

3. **逻辑控制模块**

   - 实现表单逻辑跳转功能，支持条件显示/隐藏
   - 使用表达式引擎处理逻辑条件判断
   - 支持多条件组合（AND/OR）逻辑

4. **权限控制模块**

   - 基于 JWT 实现用户认证
   - 实现细粒度的权限控制，区分管理员和普通用户
   - 支持表单级别的权限设置

5. **统计分析模块**
   - 实现多维度数据统计功能
   - 支持图表数据生成和导出
   - 提供实时统计和定时统计功能

#### 9.1.2 关键技术点

1. **数据存储设计**

   - 使用 JSON 类型字段存储复杂结构数据，提高灵活性
   - 采用自定义类型处理器处理特殊数据类型
   - 实现数据分表策略，提高查询效率

2. **缓存策略**

   - 使用 EhCache 实现本地缓存
   - 对频繁访问的数据进行缓存，减轻数据库压力
   - 实现缓存更新和失效机制

3. **性能优化**
   - 使用索引优化查询性能
   - 实现分页查询，避免大数据量查询
   - 采用异步处理机制处理耗时操作

### 9.2 前端实现

#### 9.2.1 核心功能实现

1. **表单设计器**

   - 基于 Vue 组件化开发，实现拖拽式设计
   - 支持多种题型的配置和预览
   - 实现实时保存和预览功能

2. **表单渲染器**

   - 动态渲染不同类型的表单组件
   - 实现表单验证和提交功能
   - 支持移动端适配和响应式布局

3. **数据可视化**

   - 使用 ECharts 实现多种图表展示
   - 支持图表类型切换和数据筛选
   - 实现图表导出和分享功能

4. **用户界面**
   - 基于 Element UI 构建统一风格的界面
   - 实现主题切换和自定义样式
   - 优化用户交互体验

#### 9.2.2 关键技术点

1. **状态管理**

   - 使用 Vuex 管理全局状态
   - 实现组件间数据共享和通信
   - 优化状态更新和渲染性能

2. **路由设计**

   - 基于 Vue Router 实现前端路由
   - 支持路由守卫和权限控制
   - 实现页面切换动画和状态保持

3. **性能优化**
   - 组件懒加载和按需加载
   - 资源压缩和缓存策略
   - 虚拟滚动处理大量数据展示

### 9.3 数据库设计详解

#### 9.3.1 核心表结构

1. **用户表单表(fm_user_form)**

   - 存储表单基本信息，包括标题、描述、状态等
   - 关联用户 ID，实现用户与表单的关系
   - 包含表单类型、来源等信息

2. **表单项表(fm_user_form_item)**

   - 存储表单中的题目信息
   - 包含题目类型、标题、选项、验证规则等
   - 支持排序和分组功能

3. **表单数据表(fm_user_form_data)**

   - 存储用户填写的表单数据
   - 使用 JSON 格式存储原始数据
   - 记录填写时间、IP、设备等信息

4. **表单逻辑表(fm_user_form_logic)**
   - 存储表单的逻辑规则
   - 支持条件显示和跳转逻辑
   - 使用 JSON 格式存储复杂逻辑结构

#### 9.3.2 索引设计

- 对常用查询字段创建索引，如 formKey、userId 等
- 对关联查询创建联合索引，提高查询效率
- 合理设计主键和外键关系，保证数据完整性

#### 9.3.3 数据存储优化

- 使用 JSON 类型存储复杂结构，减少表关联
- 对大字段使用压缩存储，节省空间
- 实现数据分表策略，提高查询性能

## 10. 系统部署

### 10.1 部署架构

- 采用前后端分离部署方式
- 前端静态资源部署在 Nginx 服务器
- 后端服务部署在 Tomcat 容器
- 数据库独立部署，确保安全和性能

### 10.2 部署流程

1. **环境准备**

   - 安装 JDK、MySQL、Nginx 等基础环境
   - 配置网络和防火墙设置
   - 准备部署脚本和配置文件

2. **后端部署**

   - 编译打包后端项目
   - 配置数据库连接和系统参数
   - 启动后端服务并验证接口可用性

3. **前端部署**

   - 构建前端项目生成静态资源
   - 配置 Nginx 代理和路由规则
   - 部署静态资源并测试访问

4. **系统配置**
   - 配置域名和 SSL 证书
   - 设置系统初始参数
   - 创建管理员账号和基础数据

### 10.3 运维管理

- 实现日志收集和监控
- 配置定时备份策略
- 制定故障恢复方案
- 实现系统性能监控和告警

## 11. 总结

本问卷系统是一个功能完善、易用性强的在线调查工具，通过前后端分离架构和现代化技术栈的应用，实现了高效的问卷设计、数据收集和分析功能。系统支持多种题型和灵活的逻辑设置，满足各类调查场景的需求。

从技术实现角度，系统采用了 Spring Boot + Vue.js 的技术栈，结合 MyBatis-Plus、Element UI 等框架，实现了高效的开发和良好的用户体验。在数据存储方面，采用了灵活的 JSON 存储方式，支持复杂的表单结构和数据分析需求。

系统注重用户体验和数据安全，为用户提供了一个可靠、高效的问卷调查平台。通过精心设计的用户界面和流程，使用户能够轻松创建、发布和管理问卷，并获取有价值的数据分析结果。

未来，系统将继续优化性能，丰富功能，提升用户体验，以适应更多样化的调查需求和应用场景。可能的发展方向包括：

- 引入人工智能辅助分析功能
- 增强多平台集成能力
- 提供更丰富的模板和题型
- 优化移动端体验和性能















# 问卷系统核心代码摘要

本文档收集了问卷系统的核心代码片段，按功能模块进行组织。

## 1. 问卷表单核心模块

### 1.1 用户表单实体类 (UserFormEntity)

```java
/**
 * 用户表单表(Form)表实体类
 */
@Data
@FieldNameConstants
@TableName(value = "fm_user_form", autoResultMap = true)
public class UserFormEntity extends BaseEntity<UserFormEntity> {
    /**
     * 表单code
     */
    @NotBlank(message = "错误请求", groups = { UpdateGroup.class })
    private String formKey;
    /**
     * 表单名称
     */
    @NotBlank(message = "表单名称不能为空", groups = { AddGroup.class, UpdateGroup.class })
    private String name;
    /**
     * 表单描述
     */
    private String description;

    /**
     * 表单来源
     */
    private FormSourceTypeEnum sourceType;

    /**
     * 来源ID
     */
    private String sourceId;

    /**
     * 用户ID
     */
    private Long userId;

    /***
     * 状态
     */
    private FormStatusEnum status;
    /**
     * 表单类型
     */
    private FormTypeEnum type;
}
```

### 1.2 表单项实体类 (UserFormItemEntity)

```java
/**
 * 表单表单项(FormItem)表实体类
 */
@Data
@Accessors(chain = true)
@FieldNameConstants
@JsonIgnoreProperties(ignoreUnknown = true)
@TableName(value = "fm_user_form_item", autoResultMap = true)
public class UserFormItemEntity extends BaseEntity<UserFormItemEntity> {
    /**
     * 表单Id
     */
    @NotNull(message = "key请求异常", groups = {AddGroup.class, UpdateGroup.class})
    private String formKey;
    /**
     * 表单项Id 类型  + 时间戳
     */
    @NotNull(message = "Id请求错误", groups = {AddGroup.class, UpdateGroup.class})
    private String formItemId;
    /**
     * 表单项类型
     */
    @NotNull(message = "类型请求错误", groups = {AddGroup.class, UpdateGroup.class})
    private String type;

    /**
     * 是否必填
     */
    @TableField(typeHandler = BooleanTypeHandler.class)
    private Boolean required;

    /**
     * 排序
     */
    private Long sort;
}
```

### 1.3 表单数据实体类 (UserFormDataEntity)

```java
/**
 * 表单数据(FormResult)表实体类
 */
@Data
@Accessors(chain = true)
@FieldNameConstants
@TableName(value = "fm_user_form_data", autoResultMap = true)
public class UserFormDataEntity extends SysBaseEntity {

    /**
     * 表单key
     */
    @NotBlank(message = "错误请求")
    private String formKey;

    /**
     * 提交序号
     */
    private Long serialNumber;

    /**
     * 填写结果原始数据
     */
    @TableField(typeHandler = JacksonTypeHandler.class)
    private Map<String, Object> originalData;

    @TableField(exist = false)
    private FormTypeEnum formType;
}
```

### 1.4 表单模板服务实现 (FormTemplateServiceImpl)

```java
/**
 * 表单表(FormTemplate)表服务实现类
 */
@Service
@RequiredArgsConstructor
public class FormTemplateServiceImpl extends ServiceImpl<FormTemplateMapper, FormTemplateEntity> implements FormTemplateService {
    private final UserFormItemService userFormItemService;
    private final UserFormService userFormService;
    private final UserFormThemeService userFormThemeService;
    private final UserFormLogicService userFormLogicService;

    @Override
    public FormTemplateEntity getByKey(String key) {
        return this.getOne(Wrappers.<FormTemplateEntity>lambdaQuery().eq(FormTemplateEntity::getFormKey, key));
    }

    @Override
    @Transactional
    public FormTemplateEntity createFormTemplate(FormTemplateEntity formTemplateEntity) {
        //保存基础信息和问题
        String formKey = formTemplateEntity.getFormKey();
        formTemplateEntity.setFormKey(ShortIdUtils.genId());
        // 查询表单
        UserFormEntity userFormEntity = userFormService.getByKey(formKey);
        List<UserFormItemEntity> itemEntityList = userFormItemService.listByFormKey(formKey);
        // 主题
        UserFormThemeEntity themeEntity = userFormThemeService.getByKey(formKey);
        FormTemplateEntity.Definition definition = new FormTemplateEntity.Definition();
        definition.setFormType(userFormEntity.getType().getValue());
        definition.setFormItems(itemEntityList);
        definition.setUserFormTheme(themeEntity);
        // ...
    }
}
```

## 2. 问卷数据处理模块

### 2.1 表单数据服务实现 (UserFormDataServiceImpl)

```java
/**
 * 表单数据服务实现类
 */
@Service
public class UserFormDataServiceImpl extends ServiceImpl<UserFormDataMapper, UserFormDataEntity> implements UserFormDataService {

    private final UserFormItemService userFormItemService;
    private final CacheUtils redisUtils;
    private final FormDataUtils formDataUtils;

    @Override
    @Transactional(rollbackFor = Exception.class)
    public Map<String, Object> saveFormResult(UserFormDataEntity entity) {
        HashMap<String, Object> result = MapUtil.newHashMap();
        String formKey = entity.getFormKey();
        entity.setSubmitAddress(AddressUtils.getRealAddressByIP(entity.getSubmitRequestIp()));
        entity.setSerialNumber(
                redisUtils.incr(StrUtil.format(FORM_RESULT_NUMBER, formKey), CommonConstants.ConstantNumber.ONE));
        this.save(entity);
        formDataUtils.syncSaveFormData(entity);
        result.put("id", entity.getId());
        FormWebHookUtils.pushFormDataSaveWebHook(entity, WEBHOOK_EVENT_TYPE_FORM_DATA_ADD);
        return result;
    }

    /**
     * 下载表单结果中的附件
     */
    @Override
    public Result downloadFormResultFile(QueryFormResultRequest request) {
        String uuid = IdUtil.simpleUUID();
        List<UserFormItemEntity> userFormItemEntityList = userFormItemService.list(
                Wrappers.<UserFormItemEntity>lambdaQuery().eq(UserFormItemEntity::getFormKey, request.getFormKey())
                        .in(UserFormItemEntity::getType, CollUtil.newArrayList(FormItemTypeEnum.UPLOAD.toString(),
                                FormItemTypeEnum.IMAGE_UPLOAD.toString())));
        // 结果
        List<Map> rows = null;
        if (ObjectUtil.isNull(request.getCurrent()) && ObjectUtil.isNull(request.getSize())) {
            rows = formDataUtils.searchAll(request);
        } else {
            FormDataTableVO formDataTableVO = this.listFormDataTable(request);
            rows = formDataTableVO.getRows();
        }
        // ...
    }

    @Override
    public FormDataTableVO listFormDataTable(QueryFormResultRequest request) {
        return formDataUtils.search(request);
    }
}
```

### 2.2 表单数据 MySQL 服务 (FormDataMysqlService)

```java
/**
 * 表单数据基础服务
 */
@Service
@Slf4j
public class FormDataMysqlService extends FormDataBaseService {

    @Autowired
    private UserFormDataMapper userFormDataMapper;

    @Autowired(required = false)
    private TduckMongoTemplate mongoTemplate;

    @Override
    public Boolean valueExist(String formKey, String formItemId, Object value) {
        return userFormDataMapper.selectOriginalDataValueCount(formKey, formItemId, value) > 0;
    }

    @Override
    public Boolean syncSaveData(UserFormDataEntity result) {
        if (null == mongoTemplate) {
            return true;
        }
        mongoTemplate.save(convertDocument(result), result.getFormKey());
        return true;
    }

    @Override
    public FormDataTableVO search(QueryFormResultRequest request) {
        // 校验formKey只允许存在字符串和数字
        if (StrUtil.isBlank(request.getFormKey()) || !request.getFormKey().matches("^[a-zA-Z0-9]+$")) {
            return new FormDataTableVO();
        }
        // 拼接sql
        StringBuilder sqlBuilder = new StringBuilder();
        sqlBuilder.append("select * from fm_user_form_data where form_key = '").append(request.getFormKey()).append("'");
        //1. 拼接条件 查询条件 用大括号包起来 里面的条件会拼接 OR 或者 AND 不能影响其他默认附带条件 比如form_key 否则会错误查询
        StringBuilder whereBuilder = new StringBuilder();
        // 查询指定id数据
        if (ObjectUtil.isNotNull(request.getDataIds()) && 0 != request.getDataIds().size()) {
            whereBuilder.append(" and id in (").append(CollUtil.join(request.getDataIds(), ",")).append(")");
        }
        // ...
    }
}
```

### 2.3 表单结果控制器 (UserFormResultController)

```java
/**
 * 表单结果控制器
 */
@RestController
@RequestMapping("/user/form/data")
public class UserFormResultController {

    /**
     * 查询数据
     */
    @PostMapping("query")
    public Result queryFormDataTable(@RequestBody QueryFormResultRequest request) {
        FormAuthUtils.hasPermission(request.getFormKey());
        return Result.success(formResultService.listFormDataTable(request));
    }

    /**
     * 获取某条数据详情
     */
    @GetMapping("details/{dataId}")
    @PermitAll
    public Result getFormDataDetails(@PathVariable("dataId") String dataId) {
        return formResultService.getFormDataDetails(dataId);
    }

    /**
     * 填写附件导出
     */
    @PostMapping("/download/file")
    public Result downloadFormResultFile(@RequestBody QueryFormResultRequest request) {
        return formResultService.downloadFormResultFile(request);
    }

    /**
     * 填写
     */
    @PostMapping("/create")
    public Result createFormResult(@RequestBody UserFormDataEntity entity, HttpServletRequest request) {
        ValidatorUtils.validateEntity(entity);
        entity.setSubmitRequestIp(HttpUtils.getIpAddr(request));
        // 如果已经登陆了也记录用户信息 try catch 避免抛出异常
        entity.setCreateBy(SecurityUtils.getUserId() != null ? String.valueOf(SecurityUtils.getUserId()) : null);
        // 如果没有登录，使用提交的用户名和邮箱
        if (entity.getCreateBy() == null && StrUtil.isNotBlank(entity.getUserName())
                && StrUtil.isNotBlank(entity.getUserEmail())) {
            log.info("未登录用户提交问卷，使用提交的用户信息：userName={}, userEmail={}", entity.getUserName(), entity.getUserEmail());
        }
        Map<String, Object> result = formResultService.saveFormResult(entity);
        return Result.success(result);
    }

    /**
     * 公开填写
     */
    @PostMapping("/public/create")
    @PermitAll
    public Result<Map<String, Object>> createPublicFormResult(@RequestBody UserFormDataEntity entity,
            HttpServletRequest request) {
        ValidatorUtils.validateEntity(entity);
        entity.setSubmitRequestIp(HttpUtils.getIpAddr(request));
        Result<Boolean> userFormSettingStatus = userFormSettingService.getUserFormWriteSettingStatus(
                entity.getFormKey(), entity.getSubmitRequestIp(), entity.getWxOpenId(),
                CommonConstants.ConstantNumber.ONE);
        if (StrUtil.isNotBlank(userFormSettingStatus.getMsg())) {
            return Result.failed(userFormSettingStatus.getMsg());
        }
        // 如果已经登陆了也记录用户信息
        entity.setCreateBy(SecurityUtils.getUserId() != null ? String.valueOf(SecurityUtils.getUserId()) : null);
        // 如果没有登录，使用提交的用户名和邮箱
        if (entity.getCreateBy() == null && StrUtil.isNotBlank(entity.getUserName())
                && StrUtil.isNotBlank(entity.getUserEmail())) {
            log.info("未登录用户公开提交问卷，使用提交的用户信息：userName={}, userEmail={}", entity.getUserName(), entity.getUserEmail());
        }
        Map<String, Object> result = formResultService.saveFormResult(entity);
        ThreadUtil.execAsync(() -> {
            sendWriteResultNotify(entity.getFormKey());
        });
        return Result.success(result);
    }
}
```

## 3. 前端核心模块

### 3.1 问卷广场 (square/index.vue)

```javascript
export default {
  name: "ProjectSquare",
  components: {
    VueQr,
  },
  data() {
    return {
      formList: [],
      total: 0,
      pageSize: 12,
      currentPage: 1,
      loading: true,
      isLoggedIn: false,
      shareDialogVisible: false,
      shareLink: "",
      currentForm: null,
      qrCodeUrl: "",
      baseUrl: "",
      answeredForms: {}, // 存储用户已回答的问卷
    };
  },

  methods: {
    fetchFormList() {
      this.loading = true;
      getRequest("/user/form/public/list", {
        page: this.currentPage,
        size: this.pageSize,
      })
        .then((res) => {
          if (res.code === 200) {
            this.formList = res.data.records || [];
            // 确保每个表单项都有userId字段
            this.formList.forEach((form) => {
              if (!form.userId && form.userId !== 0) {
                // 如果没有userId字段，根据userAdmin字段设置默认值
                form.userId = form.userAdmin ? 1 : 2;
              }
              // 初始化已答题状态为false
              form.isAnswered = this.answeredForms[form.formKey] || false;
            });
            this.total = res.data.total || 0;

            // 检查已回答的问卷
            this.checkAnsweredForms();
          } else {
            this.$message.error("获取问卷列表失败");
            this.formList = [];
            this.total = 0;
          }
        })
        .finally(() => {
          this.loading = false;
        });
    },

    goToWriteForm(formKey) {
      // 查找当前表单
      const form = this.formList.find((item) => item.formKey === formKey);

      // 如果表单已经填写过，则显示提示信息而不跳转
      if (form && form.isAnswered) {
        this.$message({
          message: "您已经填写过此问卷，无需重复填写",
          type: "info",
        });
        return;
      }

      // 重新检查登录状态，确保使用最新的状态
      this.checkLoginStatus();
      console.log(
        "点击开始填写 - 用户登录状态:",
        this.isLoggedIn,
        "表单Key:",
        formKey
      );

      // 根据用户登录状态决定使用哪个路由
      if (this.isLoggedIn) {
        console.log("使用登录用户路由: /form/" + formKey);
        this.$router.push(`/form/${formKey}`);
      } else {
        console.log("使用未登录用户路由: /s/" + formKey);
        this.$router.push(`/s/${formKey}`);
      }
    },
  },
};
```

### 3.2 问卷填写 (write/index.vue)

```javascript
<template>
  <div class="form-container">
    <!-- 表单填写状态 -->
    <div v-if="writeStatus == 1" class="form-content" :class="{ 'shared-mode': true }">
      <!-- 用户信息悬浮卡片 - 包含表单元信息 -->
      <user-info-input
        ref="userInfoInput"
        v-if="formConfig.formKey"
        :form-info="{
          formCreator,
          formCreateTime,
          formStats
        }"
      />

      <!-- 表单内容 -->
      <biz-project-form
        v-if="formConfig.formKey"
        ref="bizProjectForm"
        :form-config="formConfig"
        @submit="submitForm"
        class="form-body"
        v-floating-submit
      />
    </div>

    <!-- 提交成功状态 -->
    <div v-cloak v-if="writeStatus == 2" class="form-status-container">
      <div v-if="userFormSetting.submitShowType === 2" v-html="userFormSetting.submitShowCustomPageContent" />
      <el-result v-else :title="'提交成功'" icon="success" />
    </div>
  </div>
</template>

<script>
export default {
  // ...
  methods: {
    async submitForm(data) {
      try {
        // 验证用户信息
        const userInfo = await this.$refs.userInfoInput.validate()

        // 完成时间
        this.submitFormData.completeTime = document.getElementById('inActiveTime').innerText
        this.submitFormData.wxUserInfo = this.wxUserInfo
        this.submitFormData.wxOpenId = this.wxUserInfo ? this.wxUserInfo.openid : ''
        this.submitFormData.originalData = data.formModel
        this.submitFormData.formKey = this.formKey
        this.submitFormData.formId = data.formId
        this.submitFormData.formType = this.$refs.bizProjectForm.formConf.formType

        // 添加用户名和邮箱信息
        this.submitFormData.userName = userInfo.userName
        this.submitFormData.userEmail = userInfo.userEmail

        // 提交表单数据
        // ...
      } catch (error) {
        // 处理错误
      }
    }
  }
}
</script>
```

### 3.3 表单数据管理 (data/index.vue)

```javascript
export default {
  components: {
    BizProjectForm,
    ViewOrUpdate,
    BaseTable,
    DownloadFile,
    Import,
    DataFilter,
  },
  data() {
    return {
      formKey: "",
      formConfig: {
        formKey: "",
        preview: false,
        showBtns: true,
      },
      formModel: {},
      selectRecords: [],
      selectDataId: "",
      addDialogVisible: false,
      queryDialogVisible: false,
      formParseKey: 0,
      fields: [],
      fixedFields: [],
      queryParams: {
        filter: {
          conditionList: [],
          conditionType: "and",
        },
      },
      gridOptions: {
        border: true,
        resizable: true,
        showOverflow: true,
        highlightHoverRow: true,
        rowId: "id",
        height: "auto",
        printConfig: {
          columns: [],
        },
      },
    };
  },
  methods: {
    handleQueryFields() {
      return new Promise((resolve, reject) => {
        if (this.mode === 1) {
          listFormFieldsRequest(this.formKey).then((res) => {
            this.handleTableColumns(res.data);
            resolve(this.fields);
          });
        } else {
          listFormFieldsRequest(this.formKey).then((res) => {
            let haveFieldIds = this.authGroup.fieldVisiblePerms;
            this.fields = res.data.filter((item) =>
              haveFieldIds.includes(item.value)
            );
            this.handleTableColumns(this.fields);
            resolve(this.fields);
          });
          this.queryParams.authGroupId = this.authGroup.id;
        }
      });
    },

    submitForm(data) {
      createFormResultRequest({
        completeTime: 0,
        formKey: this.formConfig.formKey,
        submitOs: "",
        submitBrowser: "",
        submitUa: null,
        wxUserInfo: null,
        wxOpenId: "",
        originalData: data.formModel,
      }).then(() => {
        setTimeout(() => {
          this.$refs.baseTable.getXGrid().commitProxy("reload");
        }, 1000);
        this.addDialogVisible = false;
        this.msgSuccess("添加成功");
      });
    },
  },
};
```

## 4. 用户认证与权限管理模块

### 4.1 用户服务实现 (UserServiceImpl)

```java
/**
 * 用户(AcUser)表服务实现类
 */
@Slf4j
@Service("userService")
@RequiredArgsConstructor
public class UserServiceImpl extends ServiceImpl<UserMapper, UserEntity> implements UserService {

    private final JwtUtils jwtUtils;
    private final CacheUtils cacheUtils;
    private final UserTokenService userTokenService;
    private final UserAuthorizeService userAuthorizeService;

    @Override
    public Result emailRegister(RegisterAccountRequest request) {
        String code = cacheUtils.getTemp(StrUtil.format(AccountRedisKeyConstants.EMAIL_CODE, request.getEmail()));
        if (!request.getCode().equals(code)) {
            return Result.failed("验证码错误");
        }
        if (ObjectUtil.isNotNull(getUserByEmail(request.getEmail()))) {
            return Result.failed("该邮箱已经注册");
        }
        UserEntity userEntity = new UserEntity();
        userEntity.setEmail(request.getEmail());
        userEntity.setPassword(request.getPassword());
        userEntity.setRegChannel(AccountChannelEnum.EMAIL);
        this.createUser(userEntity);
        return Result.success();
    }

    /**
     * 创建用户
     */
    private void createUser(UserEntity userEntity) {
        userEntity.setName(NameUtils.getCnName());
        userEntity.setAvatar(AccountConstants.DEFAULT_AVATAR);
        userEntity.setPasswordType(1);
        userEntity.setPassword(PasswordUtils.encode(userEntity.getPassword()));
        this.save(userEntity);
    }

    @Override
    public Result accountLogin(AccountLoginRequest request) {
        UserEntity userEntity;
        if (ReUtil.isMatch(Validator.EMAIL, request.getAccount())) {
            userEntity = getUserByEmail(request.getAccount());
        } else {
            userEntity = getUserByPhoneNumber(request.getAccount());
        }
        if (ObjectUtil.isNull(userEntity) || !PasswordUtils.checkPassword(userEntity, request.getPassword())) {
            return Result.failed("账号或密码错误");
        }
        updatePasswordType(userEntity, request.getPassword());
        return Result.success(getLoginResult(userEntity,
                ReUtil.isMatch(Validator.EMAIL, request.getAccount()) ? AccountChannelEnum.EMAIL : AccountChannelEnum.PHONE,
                request.getRequestIp()));
    }

    /**
     * 获取登录结果
     */
    @Override
    public LoginUserVO getLoginResult(UserEntity userEntity, AccountChannelEnum channel, String requestIp) {
        userEntity.setLastLoginIp(requestIp);
        userEntity.setLastLoginChannel(channel);
        userEntity.setLastLoginTime(LocalDateTime.now());
        this.updateById(userEntity);
        String token = jwtUtils.generateToken(userEntity.getId());
        // 缓存token
        userTokenService.saveToken(token, userEntity.getId(), LocalDateTime.now().plusSeconds(jwtUtils.getExpire()));
        return new LoginUserVO(userEntity.getAvatar(), userEntity.getName(), token, userEntity.isAdmin());
    }
}
```

### 4.2 JWT 工具类 (JwtUtils)

```java
/**
 * jwt工具类
 */
@ConfigurationProperties(prefix = "platform.jwt")
@Component
@Slf4j
@Data
public class JwtUtils {

    private String secret;
    private long expire;
    private String header;

    /**
     * 生成jwt token
     */
    public String generateToken(long userId) {
        Date nowDate = new Date();
        //过期时间
        Date expireDate = new Date(nowDate.getTime() + expire * 1000);

        return Jwts.builder()
                .setHeaderParam("typ", "JWT")
                .setSubject(String.valueOf(userId))
                .setIssuedAt(nowDate)
                .setExpiration(expireDate)
                .signWith(SignatureAlgorithm.HS512, secret)
                .compact();
    }

    public Claims getClaimByToken(String token) {
        try {
            return Jwts.parser()
                    .setSigningKey(secret)
                    .parseClaimsJws(token)
                    .getBody();
        } catch (Exception e) {
            log.debug("validate is token com.tduck.cloud.wx.mp.error ", e);
            return null;
        }
    }

    /**
     * token是否过期
     *
     * @return true：过期
     */
    public boolean isTokenExpired(Date expiration) {
        return expiration.before(new Date());
    }
}
```

### 4.3 授权拦截器 (AuthorizationInterceptor)

```java
/**
 * 授权拦截器
 */
@Component
public class AuthorizationInterceptor extends HandlerInterceptorAdapter {
    public static final String USER_KEY = "userId";

    private final JwtUtils jwtUtils;
    private final UserTokenService userTokenService;

    public AuthorizationInterceptor(JwtUtils jwtUtils, UserTokenService userTokenService) {
        this.jwtUtils = jwtUtils;
        this.userTokenService = userTokenService;
    }

    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
        // 是否不需要登录
        NotLogin annotation;
        PermitAll permitAll;
        if (handler instanceof HandlerMethod) {
            annotation = ((HandlerMethod) handler).getMethodAnnotation(NotLogin.class);
            permitAll = ((HandlerMethod) handler).getMethodAnnotation(PermitAll.class);
        } else {
            return true;
        }

        if (annotation != null || permitAll != null) {
            return true;
        }

        //获取用户凭证
        String token = request.getHeader(jwtUtils.getHeader());
        if (StrUtil.isBlank(token)) {
            token = request.getParameter(jwtUtils.getHeader());
        }

        //凭证为空
        if (StrUtil.isBlank(token)) {
            throw new AuthorizationException(jwtUtils.getHeader() + "不能为空");
        }

        Claims claims = jwtUtils.getClaimByToken(token);
        if (claims == null || jwtUtils.isTokenExpired(claims.getExpiration())) {
            throw new AuthorizationException(jwtUtils.getHeader() + "失效，请重新登录");
        }
        long userId = Long.parseLong(claims.getSubject());
        // 缓存中是否存在token
        boolean verified = userTokenService.verifyToken(token, userId);
        if (!verified) {
            throw new AuthorizationException(jwtUtils.getHeader() + "失效，请重新登录");
        }
        // 设置userId到request里，后续根据userId，获取用户信息
        request.setAttribute(USER_KEY, userId);
        // 不允许访问
        if (StrUtil.containsAny(request.getRequestURI(), "/mange/", "/system/env/")) {
            if (!SecurityUtils.isAdmin(userId)) {
                throw new AuthorizationException("无权限访问");
            }
        }
        return true;
    }
}
```

### 4.4 表单权限工具类 (FormAuthUtils)

```java
/**
 * 表单权限工具类
 */
@UtilityClass
public class FormAuthUtils {

    /**
     * 是否拥有表单的权限
     */
    public void hasPermission(String formKey) {
        // 是否是超级管理员
        if (SecurityUtils.isAdmin(SecurityUtils.getUserId())) {
            return;
        }
        UserFormService userFormService = SpringContextUtils.getBean(UserFormService.class);
        UserFormEntity userFormEntity = userFormService.getByKey(formKey);
        if(ObjectUtil.isNull(userFormEntity)){
            return;
        }
        // 是否是所有者
        if (!userFormEntity.getUserId().equals(SecurityUtils.getUserId())) {
            throw new BaseException("无表单权限");
        }
    }
}
```

## 5. 系统配置与工具类模块

### 5.1 系统环境配置服务 (SysEnvConfigServiceImpl)

```java
/**
 * 系统环境配置Service业务层处理
 */
@Service
@RequiredArgsConstructor
public class SysEnvConfigServiceImpl extends ServiceImpl<SysEnvConfigMapper, SysEnvConfigEntity> implements SysEnvConfigService {

    /**
     * 本地缓存
     */
    private final Map<String, String> cacheMap = new ConcurrentHashMap<>();

    @PostConstruct
    public void initCache() {
        List<SysEnvConfigEntity> list = this.list();
        list.forEach(config -> {
            cacheMap.put(config.getEnvKey(), JsonUtils.objToJson(config.getEnvValue()));
        });
    }

    @Override
    public SysEnvConfigEntity getByKey(String key) {
        return baseMapper.selectOne(Wrappers.<SysEnvConfigEntity>lambdaQuery().eq(SysEnvConfigEntity::getEnvKey, key));
    }

    @Override
    public SystemInfoConfig getSystemEnvConfig() {
        return JsonUtils.jsonToObj(getValueByKey(ConfigConstants.SYSTEM_INFO_CONFIG), SystemInfoConfig.class);
    }

    @Override
    public String getValueByKey(String key) {
        String cacheValue = cacheMap.get(key);
        if (StringUtils.isNotEmpty(cacheValue)) {
            return cacheValue;
        }
        SysEnvConfigEntity config = getByKey(key);
        if (ObjectUtil.isNotNull(config)) {
            return JsonUtils.objToJson(config.getEnvValue());
        }
        return StringUtils.EMPTY;
    }

    @Override
    public void saveConfig(SysEnvConfigEntity config) {
        SysEnvConfigEntity envConfig = getByKey(config.getEnvKey());
        if (ObjectUtil.isNull(envConfig)) {
            envConfig = new SysEnvConfigEntity();
        }
        envConfig.setEnvKey(config.getEnvKey());
        envConfig.setEnvValue(config.getEnvValue());
        this.saveOrUpdate(envConfig);
        cacheMap.put(config.getEnvKey(), JsonUtils.objToJson(config.getEnvValue()));
        SpringContextUtils.publishEvent(new EnvConfigRefreshEvent(this, config));
    }
}
```

### 5.2 缓存工具类 (CacheUtils)

```java
/**
 * 基于ehcache实现的缓存工具类
 */
@Component
@Slf4j
public class CacheUtils {
    private final String ETERNAL_CACHE_NAME = "eternal_cache";
    private final String TEMP_CACHE_NAME = "temp_cache";
    @Autowired
    private EhCacheCacheManager cacheManager;

    /**
     * 保存到Cache
     */
    public void save(String key, String value) {
        cacheManager.getCache(ETERNAL_CACHE_NAME).put(key, value);
    }

    /**
     * 获取
     */
    public String get(String key) {
        Cache.ValueWrapper valueWrapper = cacheManager.getCache(ETERNAL_CACHE_NAME).get(key);
        if (ObjectUtil.isNotNull(valueWrapper) && ObjectUtil.isNotNull(valueWrapper.get())) {
            return valueWrapper.get().toString();
        }
        return null;
    }

    /**
     * 获取集合
     */
    public List getList(String key, Class classz) {
        String v = get(key);
        if (ObjectUtil.isNotNull(v)) {
            return JsonUtils.jsonToList(v, classz.getClass());
        }
        return Lists.newArrayList();
    }

    /**
     * 临时保存 默认5min
     */
    public void tempSave(String key, String value) {
        cacheManager.getCache(TEMP_CACHE_NAME).put(key, value);
    }

    /**
     * 获取临时存储变量
     */
    public String getTemp(String key) {
        Cache.ValueWrapper valueWrapper = cacheManager.getCache(TEMP_CACHE_NAME).get(key);
        if (ObjectUtil.isNotNull(valueWrapper) && ObjectUtil.isNotNull(valueWrapper.get())) {
            return valueWrapper.get().toString();
        }
        return null;
    }

    public void removeTemp(String key) {
        cacheManager.getCache(TEMP_CACHE_NAME).evict(key);
    }
}
```

### 5.3 结果封装类 (Result)

```java
/**
 * 响应信息主体
 */
@ToString
@NoArgsConstructor
@AllArgsConstructor
@Accessors(chain = true)
@Schema(description = "响应信息主体")
public class Result<T> implements Serializable {
    private static final long serialVersionUID = 1L;

    @Getter
    @Setter
    @Schema(description = "返回标记：成功标记=200，失败标记=500")
    private int code = ResponseCodeConstants.SUCCESS;

    @Getter
    @Setter
    @Schema(description = "返回信息")
    private String msg;

    @Getter
    @Setter
    @Schema(description = "数据")
    private T data;

    public static <T> Result<T> success() {
        return restResult(null, ResponseCodeConstants.SUCCESS, null);
    }

    public static <T> Result<T> success(T data) {
        return restResult(data, ResponseCodeConstants.SUCCESS, null);
    }

    public static <T> Result<T> success(T data, String msg) {
        return restResult(data, ResponseCodeConstants.SUCCESS, msg);
    }

    public static <T> Result<T> isSuccess(boolean flag) {
        return flag ? success() : failed();
    }

    public static <T> Result<T> failed() {
        return restResult(null, ResponseCodeConstants.FAIL, null);
    }

    public static <T> Result<T> failed(int code, String msg) {
        return restResult(null, code, msg);
    }

    public static <T> Result<T> failed(String msg) {
        return restResult(null, ResponseCodeConstants.FAIL, msg);
    }

    public static <T> Result<T> failed(String msg, T data) {
        return restResult(data, ResponseCodeConstants.FAIL, msg);
    }

    public static <T> Result<T> restResult(T data, int code, String msg) {
        Result<T> apiResult = new Result<>();
        apiResult.setCode(code);
        apiResult.setData(data);
        apiResult.setMsg(msg);
        return apiResult;
    }

    @JsonIgnore
    public Boolean isDataNull() {
        return ObjectUtil.isNull(data);
    }
}
```

### 5.4 JSON 工具类 (JsonUtils)

```java
/**
 * json工具类 使用jackson
 */
public class JsonUtils {

    private final static ObjectMapper objectMapper = new ObjectMapper();

    static {
        objectMapper.disable(SerializationFeature.WRITE_DATES_AS_TIMESTAMPS);
        objectMapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);
        objectMapper.registerModule(new JavaTimeModule());
    }

    private JsonUtils() {
    }

    /**
     * 获取objectMapper实例
     */
    public static ObjectMapper getInstance() {
        return objectMapper;
    }

    /**
     * javaBean、列表数组转换为json字符串
     */
    public static String objToJson(Object obj) {
        try {
            return objectMapper.writeValueAsString(obj);
        } catch (JsonProcessingException e) {
            e.printStackTrace();
        }
        return null;
    }

    /**
     * json 转对象
     */
    public static <T> T jsonToObj(String jsonString, Class<T> clazz) {
        if (StrUtil.isBlank(jsonString)) {
            return null;
        }
        //允许出现单引号
        objectMapper.configure(JsonParser.Feature.ALLOW_SINGLE_QUOTES, true);
        //接受只有一个元素的数组的反序列化
        objectMapper.configure(DeserializationFeature.ACCEPT_SINGLE_VALUE_AS_ARRAY, true);
        try {
            return objectMapper.readValue(jsonString, clazz);
        } catch (IOException e) {
            throw new RuntimeException(e.getMessage());
        }
    }

    /**
     * json字符串转换为map
     */
    public static <T> Map<String, Object> jsonToMap(String jsonString) {
        if (StrUtil.isBlank(jsonString)) {
            return null;
        }
        ObjectMapper mapper = new ObjectMapper();
        mapper.setSerializationInclusion(JsonInclude.Include.NON_NULL);
        try {
            return mapper.readValue(jsonString, Map.class);
        } catch (JsonProcessingException e) {
            e.printStackTrace();
            return null;
        }
    }
}
```

## 6. 问卷模板与主题模块

### 6.1 表单主题实体类 (FormThemeEntity)

```java
/**
 * 表单主题外观模板(FormTheme)表实体类
 */
@Data
@TableName(value = "fm_form_theme", autoResultMap = true)
@FieldNameConstants
public class FormThemeEntity extends BaseEntity<FormThemeEntity> {

    /**
     * 主题名称
     */
    private String name;
    /**
     * 主题风格
     */
    private Long style;
    /**
     * 头部图片
     */
    private String headImgUrl;

    /**
     * 背景图片
     */
    private String backgroundImg;

    /**
     * 主题颜色
     */
    private String themeColor;
}
```

### 6.2 用户表单主题实体类 (UserFormThemeEntity)

```java
/**
 * 表单表单项(UserFormTheme)表实体类
 */
@Data
@JsonIgnoreProperties(ignoreUnknown = true)
@TableName(value = "fm_user_form_theme", autoResultMap = true)
public class UserFormThemeEntity extends BaseEntity<UserFormThemeEntity> {
    /**
     * 表单key
     */
    @NotBlank(message = "formKey不能为空")
    private String formKey;

    /**
     * logo图片
     */
    private String logoImg;

    /**
     * logo位置
     */
    private String logoPosition;

    /**
     * 头部图片
     */
    private String headImgUrl;

    /**
     * 主题颜色
     */
    private String themeColor;

    /**
     * 提交按钮文字
     */
    private String submitBtnText;

    /**
     * 背景
     */
    private String backgroundColor;
}
```

### 6.3 表单主题服务实现 (FormThemeServiceImpl)

```java
/**
 * 表单主题外观模板(FormTheme)表服务实现类
 */
@Service
@RequiredArgsConstructor
public class FormThemeServiceImpl extends ServiceImpl<FormThemeMapper, FormThemeEntity> implements FormThemeService {

    private final FormThemeCategoryMapper formThemeCategoryMapper;

    @Override
    public List<FormThemeCategoryEntity> listThemeCategories() {
        return formThemeCategoryMapper.selectList(null);
    }

    @Override
    public FormThemeCategoryEntity getThemeCategory(Long categoryId) {
        return formThemeCategoryMapper.selectById(categoryId);
    }

    @Override
    public Boolean saveThemeCategory(FormThemeCategoryEntity entity) {
        return formThemeCategoryMapper.insert(entity) > 0;
    }

    @Override
    public Boolean updateThemeCategory(FormThemeCategoryEntity entity) {
        return formThemeCategoryMapper.updateById(entity) > 0;
    }

    @Override
    public Boolean deleteThemeCategory(List<Long> categoryIds) {
        return formThemeCategoryMapper.deleteBatchIds(categoryIds) > 0;
    }
}
```

### 6.4 表单主题控制器 (FormThemeController)

```java
/**
 * 表单主题
 */
@RestController
@RequestMapping("/form/")
@RequiredArgsConstructor
public class FormThemeController {
    private final FormThemeService formThemeService;

    /**
     * 查询项目主题外观模板列表
     */
    @GetMapping("theme/list")
    public Result queryThemes(QueryProThemeRequest request) {
        List<FormThemeEntity> list = formThemeService.list(Wrappers.<FormThemeEntity>lambdaQuery()
                .eq(ObjectUtil.isNotNull(request.getStyle()), FormThemeEntity::getStyle, request.getStyle()));
        return Result.success(list);
    }

    /**
     * 查询项目主题外观模板列表
     */
    @GetMapping("/theme/page")
    public Result queryPage(Page page, FormThemeEntity themeEntity) {
        return Result.success(formThemeService.page(page, QueryWrapperUtils.toSimpleQuery(themeEntity)));
    }

    /**
     * 获取项目主题外观模板详细信息
     */
    @GetMapping(value = "/theme/{id}")
    public Result getInfo(@PathVariable("id") Long id) {
        return Result.success(formThemeService.getById(id));
    }

    /**
     * 新增项目主题外观模板
     */
    @PostMapping("/theme")
    public Result save(@RequestBody FormThemeEntity formTheme) {
        return Result.success(formThemeService.save(formTheme));
    }

    /**
     * 查询项目主题外观模板列表
     */
    @GetMapping("/theme/category/list")
    public Result queryCategoryList() {
        return Result.success(formThemeService.listThemeCategories());
    }
}
```

### 6.5 用户表单主题控制器 (UserFormController 中的主题相关方法)

```java
/**
 * 项目主题保存
 */
@PostMapping("/user/form/theme/save")
public Result saveFormTheme(@RequestBody UserFormThemeEntity themeEntity) {
    ValidatorUtils.validateEntity(themeEntity);
    FormAuthUtils.hasPermission(themeEntity.getFormKey());
    if (ObjectUtil.isNull(themeEntity.getShowSubmitBtn())) {
        themeEntity.setShowSubmitBtn(true);
    }
    UserFormThemeEntity entity = userFormThemeService.getOne(Wrappers.<UserFormThemeEntity>lambdaQuery()
            .eq(UserFormThemeEntity::getFormKey, themeEntity.getFormKey()));
    if (ObjectUtil.isNotNull(entity)) {
        themeEntity.setId(entity.getId());
    }
    return Result.success(userFormThemeService.saveOrUpdate(themeEntity));
}

/**
 * 项目主题查询
 */
@GetMapping("/user/form/theme/{key}")
public Result queryThemeByKey(@PathVariable("key") String formKey) {
    FormAuthUtils.hasPermission(formKey);
    UserFormThemeEntity entity = userFormThemeService
            .getOne(Wrappers.<UserFormThemeEntity>lambdaQuery().eq(UserFormThemeEntity::getFormKey, formKey));
    return Result.success(entity);
}
```

## 7. 表单逻辑与条件设置模块

### 7.1 表单逻辑实体类 (UserFormLogicEntity)

```java
/**
 * 表单逻辑(UserFormLogic)表实体类
 */
@Data
@Accessors(chain = true)
@TableName(value = "fm_user_form_logic", autoResultMap = true)
public class UserFormLogicEntity extends BaseEntity<UserFormLogicEntity> {
    /**
     * 表单key
     */
    @NotBlank(message = "formKey不能为空")
    private String formKey;

    @TableField(typeHandler = JacksonTypeHandler.class)
    private List<Definition> scheme;

    /**
     * 逻辑定义对象
     */
    @Data
    public static class Definition {
        /**
         * 触发内容
         */
        private Set<Trigger> triggerList;
        /**
         * 条件
         */
        private Set<Condition> conditionList;
    }

    @Data
    public static class Trigger {
        /**
         * 表单项Id
         */
        private String formItemId;
        /**
         * 类型
         */
        private String type = "show";
    }

    /**
     * 条件
     */
    @Data
    public static class Condition {
        /**
         * 表单项Id
         */
        private String formItemId;
        /**
         * 表达式
         */
        private String expression;
        /**
         * 选项
         */
        private Object optionValue;

        /**
         * AND OR
         */
        private String relation;
    }
}
```

### 7.2 表单逻辑条件表达式枚举 (FormLogicConditionExpressionEnum)

```java
/**
 * 逻辑条件
 */
@Getter
@AllArgsConstructor
public enum FormLogicConditionExpressionEnum {

    EQ("eq", "等于"),
    NE("ne", "不等于");

    @EnumValue
    @JsonValue
    private String value;

    private String desc;
}
```

### 7.3 表单逻辑前端实现 (logic/index.vue)

```javascript
export default {
  name: "ProjectLogic",
  components: {},
  data() {
    return {
      saveMessage: "",
      isSave: "info",
      isLoading: false,
      formKey: "",
      // 默认逻辑结构
      defaultLogicItem: {
        // 触发内容
        triggerList: [
          {
            formItemId: null,
            type: "show",
          },
        ],
        // 逻辑条件
        conditionList: [
          {
            // 问题
            formItemId: null,
            // 条件 == > < >= <=
            expression: null,
            // 值
            optionValue: null,
            // 关系
            relation: "AND",
          },
        ],
      },
      conditionOptions: [
        {
          value: "eq",
          label: "选中",
        },
        {
          value: "ne",
          label: "未选中",
        },
        {
          value: "gt",
          label: "大于",
          types: ["RATE"],
        },
        {
          value: "ge",
          label: "大于等于",
          types: ["RATE"],
        },
        {
          value: "lt",
          label: "小于",
          types: ["RATE"],
        },
        {
          value: "le",
          label: "小于等于",
          types: ["RATE"],
        },
      ],
      allProjectItemList: [],
      logicList: [],
    };
  },
  methods: {
    getConditionOptions(formItemId) {
      if (!formItemId) return [];
      // 截取第一个数字前面的字符串
      let type = formItemId.replace(/\d+/, "").toUpperCase();
      let conditionOptions = jsonSimpleClone(this.conditionOptions);
      if (type === "RATE") {
        // 移除前两个选项
        conditionOptions.splice(0, 2);
      } else {
        conditionOptions.splice(2, 4);
      }
      return conditionOptions;
    },
    // 处理逻辑连接 只允许同时and 或者同时OR 负责逻辑会冲突
    relationChangeHandle(val, logicItem) {
      logicItem.conditionList.forEach((item) => {
        item.relation = val;
      });
    },
    // 获取条件可选择问题
    getConditionProjectItemList(logicItem) {
      return jsonSimpleClone(this.allProjectItemList).filter((item) => {
        return ["RADIO", "CHECKBOX", "SELECT", "IMAGE_SELECT", "RATE"].includes(
          item.type
        );
      });
    },
    // 获取显示问题可选择问题
    getTriggerItemList(logicItem) {
      // 作为逻辑条件的问题不能作为显示问题·
      let selectedFormItemList = logicItem.conditionList.map(
        (item) => item.formItemId
      );
      let projectItemList = jsonSimpleClone(this.allProjectItemList);
      projectItemList.forEach((item) => {
        if (selectedFormItemList.includes(item.formItemId)) {
          item.disabled = true;
        }
      });
      return projectItemList;
    },
    /**
     * 获取选择问题的选项
     */
    getFormItemOptions(formItemId) {
      let formItem = this.allProjectItemList.find(
        (item) => item.formItemId == formItemId
      );
      if (formItem) {
        return formItem.scheme.config.options;
      }
      return [];
    },
    // 查询项目逻辑数据
    queryProjectLogic() {
      getFormLogicRequest({ formKey: this.formKey }).then((res) => {
        if (res.data) {
          this.logicList = res.data.scheme ? res.data.scheme : [];
        }
      });
    },
    saveProjectLogic: debounce(430, true, function (logicList) {
      let data = { formKey: this.formKey, scheme: logicList };
      saveFormLogicRequest(data).then((res) => {
        this.isLoading = false;
        this.isSave = "";
        this.saveMessage = "已保存";
      });
    }),
  },
};
```

### 7.4 表达式处理工具 (expression.js)

```javascript
/**
 * 自定义表达式
 */
const expressionOperator = {
  eq: function (v1, v2) {
    if (!v1) {
      return false;
    }
    // 当type=CHECK_BOX时此处应为包含关系
    return Array.isArray(v1) ? v1.includes(+v2) : v1 == v2;
  },
  ne: function (v1, v2) {
    if (!v1) {
      return false;
    }
    return v1 != v2;
  },
};

/**
 * 逻辑连接符
 */
const LogicConnector = {
  1: "and",
  2: "or",
};

/**
 * 获取表达式
 * @conditionList 条件列表
 * @connector 连接符 ||或者 &&
 */
export function getExpression(conditionList, connector) {
  let exList = conditionList
    .filter((item) => {
      return Object.keys(item).length != 0;
    })
    .map((item) => {
      return `field${item.formItemId} ${item.expression} ${item.optionValue}  `;
    });
  return _.join(exList, LogicConnector[connector]);
}

/**
 * 执行表达式是否成立
 */
export function evalExpression(context, expression) {
  let exArray = expression.split(/and|or/);
  // 获取是& 还是|
  let and = expression.indexOf("and") > -1;
  let flag = false;
  for (let i = 0; i < exArray.length; i++) {
    let itemExpArr = exArray[i].split(" ");
    // 截取字段名
    let varName = itemExpArr[0];
    // 条件 等于 不等于
    let sp = itemExpArr[1];
    // 值
    let value = itemExpArr[2];
    // 比较是否成立
    let fieldValue = _.get(context, varName);
    flag = expressionOperator[sp](fieldValue, value);
    // & 一个不成立直接调出循环 返回失败
    if (and && !flag) {
      break;
      // | 一个成立直接调出循环 返回成功
    } else if (!and && flag) {
      break;
    }
  }
  return flag;
}
```

## 8. 表单设置与配置模块

### 8.1 表单设置实体类 (UserFormSettingEntity)

```java
/**
 * 表单设置对象
 */
@Data
@FieldNameConstants
@TableName(value = "fm_user_form_setting", autoResultMap = true)
public class UserFormSettingEntity extends BaseEntity {

    @NotBlank
    private String formKey;

    /**
     * 设置具体内容
     */
    @TableField(typeHandler = JacksonTypeHandler.class)
    private Map<String, Object> settings;
}
```

### 8.2 表单设置结构体 (FormSettingSchemaStruct)

```java
/**
 * 设置结构定义
 */
@Data
@NoArgsConstructor
@AllArgsConstructor
public class FormSettingSchemaStruct extends WriteSettingSchemaStruct {
    /**
     * 自定义显示类型 1 系统默认 2 自定义页面 使用submitShowCustomPageContent内容
     */
    private int submitShowType;
    /**
     * 自定义显示内容
     */
    private String submitShowCustomPageContent;
    private boolean submitJump;
    private String submitJumpUrl;

    /**
     * 显示分享图片
     */
    private boolean shareWxImg;
    /**
     * 分享图片地址
     */
    private String shareWxImgUrl;
    /**
     * 显示分享标题
     */
    private boolean shareWxTitle;
    /**
     * 分享标题内容
     */
    private String shareWxTitleContent;
    /**
     * 开启分享描述
     */
    private boolean shareWxDesc;
    /**
     * 分享描述内容
     */
    private String shareWxDescContent;
}
```

### 8.3 填写设置结构体 (WriteSettingSchemaStruct)

```java
/**
 * 设置结构定义
 */
@Data
@NoArgsConstructor
@AllArgsConstructor
public class WriteSettingSchemaStruct {

    /**
     * 仅在微信填写
     */
    private boolean onlyWxWrite;
    /**
     * 记录微信用户信息
     */
    private boolean recordWxUser;
    /**
     * 本地保存未提交数据
     */
    private boolean saveSubmitStatus;
    /**
     * 本地保存未提交数据
     */
    private boolean saveNotSubmitStatus;
    /**
     * 开启密码填写
     */
    private boolean passwordWriteStatus;
    /**
     * 填写密码
     */
    @JsonIgnore
    private String writePassword;
    /**
     * 开启每个微信答题次数限制
     */
    @JsonIgnore
    private boolean wxWriteCountLimitStatus;
    /**
     * 每个微信答题次数限制次数
     */
    @JsonIgnore
    private int wxWriteCountLimit = 1;
    /**
     * 开启每个微信答题时间限制类型
     */
    @JsonIgnore
    private int wxWriteCountLimitDateType = 1;
    /**
     * 开启每个微信答题时间限制显示文案
     */
    @JsonIgnore
    private String wxWriteCountLimitText;
    /**
     * 每个IP答题次数限制
     */
    @JsonIgnore
    private boolean ipWriteCountLimitStatus;
    /**
     * 每个IP答题次数限制次数
     */
    @JsonIgnore
    private int ipWriteCountLimit = 1;
    /**
     * 开启每个IP答题时间限制类型
     */
    @JsonIgnore
    private int ipWriteCountLimitDateType = 1;
    /**
     * 开启每个IP答题时间限制显示文案
     */
    @JsonIgnore
    private String ipWriteCountLimitText;

    /**
     * 累计答题数量
     */
    @JsonIgnore
    private boolean totalWriteCountLimitStatus;
    /**
     * 次数
     */
    @JsonIgnore
    private int totalWriteCountLimit = 1;
    /**
     * 累计答题日期范围类型
     */
    @JsonIgnore
    private int totalWriteCountLimitDateType = 1;
    /**
     * 累计答题日期范围显示文案
     */
    @JsonIgnore
    private String totalWriteCountLimitText;
    /**
     * 开启答题时间限制
     */
    @JsonIgnore
    private boolean writeInterviewTimeStatus;
    /**
     * 访问时间是否是一天内的某些小时
     */
    @JsonIgnore
    private boolean writeInterviewDayTimeStatus;
    /**
     * 允许访问访问时间范围
     */
    @JsonIgnore
    private List<String> writeInterviewDateTimeRange;
    /**
     * 允许访问访问日期范围
     */
    @JsonIgnore
    private List<String> writeInterviewDateRange;
    /**
     * 允许访问访问时间范围
     */
    @JsonIgnore
    private List<String> writeInterviewTimeRange;
    /**
     * 允许访问访问时间范围显示文案
     */
    @JsonIgnore
    private List<String> writeInterviewTimeWhichDays;
}
```

### 8.4 表单设置服务实现 (UserFormSettingServiceImpl)

```java
/**
 * 表单表单项(UserFormSetting)表服务实现类
 */
@Service
@RequiredArgsConstructor
public class UserFormSettingServiceImpl extends ServiceImpl<UserFormSettingMapper, UserFormSettingEntity> implements UserFormSettingService {
    private final UserFormService userFormService;
    private final UserFormDataService userFormDataService;

    @Override
    public Boolean saveFormSetting(Map<String, Object> params) {
        String formKey = params.get("formKey").toString();
        UserFormSettingEntity entity = this.getOne(Wrappers.<UserFormSettingEntity>lambdaQuery().eq(UserFormSettingEntity::getFormKey, formKey));
        if (ObjectUtil.isNull(entity)) {
            UserFormSettingEntity setting = new UserFormSettingEntity();
            setting.setFormKey(formKey);
            setting.setSettings(params);
            return this.save(setting);
        }
        Map<String, Object> settings = entity.getSettings();
        settings.putAll(params);
        entity.setSettings(settings);
        return this.updateById(entity);
    }

    @Override
    public UserFormSettingEntity getFormSettingByKey(String formKey) {
        return this.getOne(Wrappers.<UserFormSettingEntity>lambdaQuery().eq(UserFormSettingEntity::getFormKey, formKey));
    }

    @Override
    public FormSettingSchemaStruct getFormSettingSchema(String formKey) {
        UserFormSettingEntity settingEntity = getFormSettingByKey(formKey);
        if (ObjectUtil.isNull(settingEntity)) {
            return null;
        }
        return BeanUtil.toBean(settingEntity.getSettings(), FormSettingSchemaStruct.class);
    }

    @Override
    public Result<Boolean> getUserFormWriteSettingStatus(String formKey, String requestIp, String wxOpenId, Integer type) {
        UserFormEntity userFormEntity = userFormService.getByKey(formKey);
        boolean checkPublish = Objects.equals(type, CommonConstants.ConstantNumber.ONE) &&
                (ObjectUtil.isNull(userFormEntity) || userFormEntity.getStatus() != FormStatusEnum.RELEASE);
        // 非公开填写 不校验发布状态
        if (checkPublish) {
            return Result.success(null, "表单暂时无法填写");
        }
        UserFormSettingEntity settingEntity = getFormSettingByKey(formKey);
        if (ObjectUtil.isNull(settingEntity)) {
            return Result.success(true);
        }

        // 各种限制条件检查...

        return Result.success(true);
    }
}
```

### 8.5 表单设置控制器 (UserFormSettingController)

```java
/**
 * 表单设置
 */
@Slf4j
@RestController
@RequiredArgsConstructor
public class UserFormSettingController {

    private final UserFormSettingService userFormSettingService;
    private final WxMpUserService wxMpUserService;
    private final CacheUtils cacheUtils;
    private final WxMpService wxMpService;

    /**
     * 保存表单设置
     */
    @PostMapping("/user/form/setting/save")
    public Result<Boolean> saveFormSetting(@RequestBody Map<String, Object> setting) {
        String formKey = setting.get("formKey").toString();
        FormAuthUtils.hasPermission(formKey);
        return Result.success(userFormSettingService.saveFormSetting(setting));
    }

    /**
     * 表单提交设置查询
     */
    @GetMapping("/user/form/setting/{key}")
    public Result<Map<String, Object>> queryFormSettingByKey(@PathVariable("key") String formKey) {
        UserFormSettingEntity setting = userFormSettingService.getFormSettingByKey(formKey);
        if (ObjectUtil.isNull(setting)) {
            return Result.success();
        }
        Map<String, Object> settings = setting.getSettings();
        settings.put(UserFormSettingEntity.Fields.formKey, formKey);
        return Result.success(settings);
    }

    /**
     * 公开接口
     * 表单填写时需要的设置
     */
    @GetMapping("/user/form/public/settings/{key}")
    @PermitAll
    public Result queryPublicFormSettingByKey(@PathVariable("key") String formKey) {
        FormSettingSchemaStruct formSettingSchema = userFormSettingService.getFormSettingSchema(formKey);
        return Result.success(formSettingSchema);
    }

    /**
     * 公开接口
     * 检查填写密码是否正确
     */
    @PostMapping("/user/form/public/checkWritePwd")
    @PermitAll
    public Result<Boolean> checkWritePwd(@RequestBody @Validated CheckWritePwdRequest request) {
        FormSettingSchemaStruct formSettingSchema = userFormSettingService.getFormSettingSchema(request.getFormKey());
        if (formSettingSchema.getWritePassword().equals(request.getPassword())) {
            return Result.success(true);
        }
        return Result.failed("密码输入错误");
    }
}
```

## 9. 问卷统计与数据分析模块

### 9.1 表单报表控制器 (FormDashboardController)

```java
/**
 * 表单报表
 */
@RestController
@RequiredArgsConstructor
public class FormDashboardController {

    private final CacheUtils cacheUtils;
    private final UserFormViewCountService userFormViewCountService;
    private final UserFormDataService userFormDataService;
    private final FormDashboardService formDashboardService;

    /**
     * 表单收集信息
     */
    @GetMapping("/user/form/report/stats")
    public Result formReportStats(String formKey) {
        //浏览量
        Long viewCount = userFormViewCountService.count(formKey);
        //平均完成时间
        Map<String, Object> resultMap = userFormDataService.getMap(Wrappers.<UserFormDataEntity>query().select("AVG(complete_time) as avgCompleteTime, count(1) as completeCount").eq("form_key", formKey));
        resultMap.put("viewCount", viewCount);
        return Result.success(resultMap);
    }

    /**
     * 表单收集情况按周查看
     */
    @GetMapping("/user/form/report/situation")
    public Result formReportSituation(String formKey) {
        FormAuthUtils.hasPermission(formKey);
        return Result.success(formDashboardService.formReportSituation(formKey));
    }

    /**
     * 项目收集位置情况
     */
    @GetMapping("/user/form/report/position")
    public Result formReportPosition(String formKey) {
        FormAuthUtils.hasPermission(formKey);
        return Result.success(formDashboardService.formReportPosition(formKey));
    }

    /**
     * 项目收集设备
     */
    @GetMapping("/user/form/report/device")
    public Result formReportDevice(String formKey) {
        FormAuthUtils.hasPermission(formKey);
        return Result.success(formDashboardService.formReportDevice(formKey));
    }

    /**
     * 项目收集来源
     */
    @GetMapping("/user/form/report/source")
    public Result formReportSource(String formKey) {
        FormAuthUtils.hasPermission(formKey);
        return Result.success(formDashboardService.formReportSource(formKey));
    }

    /**
     * 数据分析
     */
    @GetMapping("/user/form/report/analysis")
    public Result formReportAnalysis(String formKey) {
        FormAuthUtils.hasPermission(formKey);
        return Result.success(formDashboardService.formReportAnalysis(formKey));
    }
}
```

### 9.2 表单报表服务实现 (FormDashboardServiceImpl)

```java
/**
 * 表单报表服务实现
 */
@Service
@RequiredArgsConstructor
public class FormDashboardServiceImpl implements FormDashboardService {
    private final FormDashboardMapper formDashboardMapper;
    private final UserFormDataService userFormDataService;
    private final UserFormItemService userFormItemService;

    @Override
    public Collection<SituationVO> formReportSituation(String formKey) {
        Date now = new Date();
        DateTime startTime = DateUtil.beginOfWeek(now);
        DateTime endTime = DateUtil.endOfWeek(now);
        Set<SituationVO> reportSituations = formDashboardMapper.selectFormReportSituation(formKey);
        List<DateTime> dateTimes = DateUtil.rangeToList(startTime, endTime, DateField.DAY_OF_WEEK);
        // 填充不存在的
        dateTimes.forEach(time -> {
            reportSituations.add(new SituationVO(time.toString(DatePattern.NORM_DATE_PATTERN), 0));
        });
        return CollectionUtil.sort(reportSituations, (o1, o2) -> DateUtil.parse(o1.getCreateTime(), DatePattern.NORM_DATE_PATTERN)
                .isAfter(DateUtil.parse(o2.getCreateTime(), DatePattern.NORM_DATE_PATTERN)) ? 1 : -1);
    }

    @Override
    public Map<String, Integer> formReportPosition(String formKey) {
        List<FormReportVO.Position> reportPositions = formDashboardMapper.selectFormReportPosition(formKey);
        return reportPositions.stream()
                .filter(item -> ObjectUtil.isNotNull(CollectionUtil.get(StrUtil.split(item.getSubmitAddress(), CharUtil.DASHED), 0)))
                .map(item -> {
                    item.setSubmitProvince(CollectionUtil.get(StrUtil.split(item.getSubmitAddress(), CharUtil.DASHED), 0));
                    return item;
                }).collect(Collectors.groupingBy(FormReportVO.Position::getSubmitProvince,
                        Collectors.summingInt(FormReportVO.Position::getCount)));
    }

    @Override
    public List<FormReportVO.Device> formReportDevice(String formKey) {
        return formDashboardMapper.selectFormReportDevice(formKey);
    }

    @Override
    public List<FormReportVO.Source> formReportSource(String formKey) {
        return formDashboardMapper.selectFormReportSource(formKey);
    }

    @Override
    public List<FormReportVO.Analysis> formReportAnalysis(String formKey) {
        List<FormItemTypeEnum> typeEnumList = CollUtil.newArrayList(
                FormItemTypeEnum.RADIO,
                FormItemTypeEnum.CHECKBOX,
                FormItemTypeEnum.IMAGE_SELECT,
                FormItemTypeEnum.SELECT
        );
        // 题目
        List<UserFormItemEntity> formItemList = userFormItemService.list(new QueryWrapper<UserFormItemEntity>().lambda().eq(UserFormItemEntity::getFormKey, formKey));
        // 结果
        List<UserFormDataEntity> formResultList = userFormDataService.list(new QueryWrapper<UserFormDataEntity>().lambda().select(UserFormDataEntity::getOriginalData).eq(UserFormDataEntity::getFormKey, formKey));
        // 标题label与id的对应值
        Map<String, FormReportVO.Analysis> formMap = new LinkedHashMap<>();
        // 储存标题与可选项
        List<String> idList = new ArrayList<>();
        for (UserFormItemEntity userFormItemEntity : formItemList) {
            if (typeEnumList.contains(userFormItemEntity.getType())) {
                // id and label
                FormReportVO.Analysis analysis = new FormReportVO.Analysis();
                analysis.setLabel(HtmlUtils.cleanHtmlTag(userFormItemEntity.getLabel()));
                analysis.setType(userFormItemEntity.getType().getDesc());
                formMap.put(userFormItemEntity.getFormItemId(), analysis);
                idList.add(userFormItemEntity.getFormItemId());
            }
        }
        for (UserFormDataEntity userFormResultEntity : formResultList) {
            Map<String, Object> originalData = userFormResultEntity.getOriginalData();
            for (String fieldId : idList) {
                Map<String, Integer> labelCountMap = formMap.get(fieldId).getMap();
                if (ObjectUtil.isNull(labelCountMap)) {
                    labelCountMap = Maps.newHashMap();
                }
                if (originalData.containsKey(fieldId)) {
                    // 结果中字段值  处理多选
                    if (originalData.get(fieldId) instanceof Collection) {
                        List<Object> fieldValues = MapUtil.get(originalData, fieldId, List.class);
                        List<String> fieldLabelValues = MapUtil.get(originalData, fieldId + "label", List.class);
                        for (int i = 0; i < fieldValues.size(); i++) {
                            // 是否是其他输入
                            Object value = fieldValues.get(i);
                            String label = value.equals(CommonConstants.ConstantNumber.ZERO) ? "其他" : fieldLabelValues.get(i);
                            Integer count = labelCountMap.get(label);
                            if(StrUtil.isNotBlank(label)) {
                                labelCountMap.put(label.trim(), ObjectUtil.isNotNull(count) ? count + 1 : 1);
                            }
                        }
                    } else {
                        String label = MapUtil.getStr(originalData, fieldId + "label");
                        Integer count = labelCountMap.get(label);
                        if(StrUtil.isNotBlank(label)){
                            labelCountMap.put(label, ObjectUtil.isNotNull(count) ? count + 1 : 1);
                        }
                    }
                }
                formMap.get(fieldId).setFieldName(labelCountMap.keySet());
                formMap.get(fieldId).setData(labelCountMap.values());
                formMap.get(fieldId).setMap(labelCountMap);
            }
        }
        List<FormReportVO.Analysis> result = new ArrayList(formMap.values());
        return result;
    }
}
```

### 9.3 表单报表数据访问层 (FormDashboardMapper)

```java
/**
 * 表单报表
 */
public interface FormDashboardMapper extends BaseMapper<UserFormDataEntity> {

    /**
     * 查询当周的每天数量
     */
    @Select(" SELECT date_format(create_time, '%Y-%m-%d') as create_time, COUNT(1) AS count\n" +
            "        FROM fm_user_form_data\n" +
            "        WHERE create_time >= YEARWEEK(now())\n" +
            "          AND form_key = #{formKey}\n" +
            "        GROUP BY date_format(create_time, '%Y-%m-%d')")
    Set<SituationVO> selectFormReportSituation(@Param("formKey") String formKey);

    /**
     * 分组查询位置
     */
    @Select("SELECT  submit_address,COUNT(1) as count FROM fm_user_form_data WHERE form_key=#{formKey}" +
            "GROUP BY submit_address")
    List<FormReportVO.Position> selectFormReportPosition(String formKey);

    /**
     * 设备
     */
    @Select("SELECT  submit_os as os_name,COUNT(1) as count FROM fm_user_form_data WHERE form_key=#{formKey}" +
            " GROUP BY submit_os")
    List<FormReportVO.Device> selectFormReportDevice(String formKey);

    /**
     * 来源
     */
    @Select("SELECT  submit_browser as browser_name,COUNT(1) as count FROM fm_user_form_data WHERE form_key=#{formKey}" +
            " GROUP BY submit_browser")
    List<FormReportVO.Source> selectFormReportSource(String formKey);
}
```

### 9.4 表单报表数据模型 (FormReportVO)

```java
/**
 * 表单报表
 */
@Data
public class FormReportVO {

    @Data
    public static class Source {
        private String browserName;
        private Integer count;
    }

    @Data
    public static class Device {
        private String osName;
        private Integer count;
    }

    /**
     * 位置
     */
    @Data
    @AllArgsConstructor
    @NoArgsConstructor
    public static class Position {
        /**
         * 提交地址 省+市
         */
        private String submitAddress;
        /**
         * 提交省
         */
        private String submitProvince;
        /**
         * 数量
         */
        private Integer count;
    }

    /**
     * 反馈数据分析
     */
    @Data
    @AllArgsConstructor
    @NoArgsConstructor
    public static class Analysis {
        /**
         * 类型
         */
        private String type;
        /**
         * 题目名称
         */
        private String label;
        /**
         * 标签集
         */
        private Set<String> fieldName;
        /**
         * 数据集
         */
        private Collection<Integer> data;
        /**
         * 合集
         */
        private Map map;
        /**
         * 图表类型
         */
        private String chartType = "pie";
    }
}
```

### 9.5 前端统计图表组件 (analysis.vue)

```javascript
export default {
  components: {
    TChart,
  },
  data() {
    return {
      initOptions: {
        renderer: "png",
      },
      list: [],
      options: [
        {
          value: "pie",
          label: "饼图",
        },
        {
          value: "bar",
          label: "柱状图",
        },
        {
          value: "line",
          label: "折线图",
        },
      ],
    };
  },
  mounted() {
    this.getData();
  },
  methods: {
    getData() {
      getFormAnalysisRequest({ formKey: this.$route.query.key }).then((res) => {
        this.list = res.data;
      });
    },
    getCharData(data) {
      let config = {
        title: {
          text: data.label,
          left: "center",
        },
        tooltip: {
          trigger: "item",
        },
        legend: {
          orient: "vertical",
          left: "left",
        },
        xAxis: [
          {
            type: "category",
            data: [],
          },
        ],
        yAxis: [
          {
            type: "value",
          },
        ],
        series: [
          {
            name: data.label,
            type: "pie",
            radius: "50%",
            data: [],
            emphasis: {
              itemStyle: {
                shadowBlur: 10,
                shadowOffsetX: 0,
                shadowColor: "rgba(0, 0, 0, 0.5)",
              },
            },
          },
        ],
      };
      // 柱状 折现图
      if (["bar", "line"].includes(data.chartType)) {
        config.tooltip.axisPointer = {
          type: "line",
        };
        config.tooltip.trigger = "axis";
        config.xAxis[0].data = data.fieldName;
        config.series[0].data = data.data;
        config.series[0].type = data.chartType;
      } else {
        config.tooltip = {
          trigger: "item",
        };
        config.series[0].data = [];
        Object.keys(data.map).forEach((key) => {
          config.series[0].data.push({ name: key, value: data.map[key] });
        });
      }
      return config;
    },
  },
};
```
